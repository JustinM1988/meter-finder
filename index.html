<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Water Meter Finder & Editor</title>
  <link rel="preconnect" href="https://js.arcgis.com" crossorigin>
  <style>
    :root{--bg:#0b1220;--panel:#111a2b;--muted:#8aa0bd;--text:#e8eefc;--accent:#22d3ee;--accent2:#2dd4bf;--danger:#ef4444}
    html,body,#app{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    #app{display:grid;grid-template-columns:360px 1fr}
    .left{border-right:1px solid #1b2942;display:flex;flex-direction:column}
    .panel{padding:14px;background:var(--panel)}
    h1{font-size:18px;margin:0 0 6px}
    .muted{color:var(--muted)}
    input,button,select{height:38px;border-radius:10px;border:1px solid #20314f;background:#0e1626;color:var(--text);padding:0 10px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(135deg,#35e0cd,#18b8a2);border:none;color:#062521;font-weight:700}
    button.ghost{background:#0e1626}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:8px}
    .stack{display:grid;gap:8px}
    .section{border-top:1px solid #1b2942;margin-top:12px;padding-top:12px}
    #list{overflow:auto;max-height:35vh;border:1px solid #1b2942;border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #1b2942;text-align:left;padding:8px}
    tr:hover{background:#0c1424}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #1b2942;color:#a6b3cc}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0e1626;border:1px solid #20314f;border-radius:6px;padding:1px 6px}
    #viewDiv{position:relative}
    .toolbar{position:absolute;top:10px;left:10px;display:flex;gap:6px;z-index:10}
    .fab{height:auto;padding:8px 10px}
    #searchDiv{position:absolute;top:10px;right:10px;z-index:10}
    .toast{position:fixed;bottom:16px;right:16px;padding:10px 12px;border-radius:12px;background:#0e1626;border:1px solid #20314f;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  </style>
</head>
<body>
<div id="app">
  <!-- LEFT PANEL -->
  <div class="left">
    <div class="panel">
      <h1>Water Meter Finder & Editor</h1>
      <div class="muted">Connect a layer, search by account/address, or draw a box to select meters. Click a result to view and update the account #.</div>
      <div class="section stack">
        <input id="layerUrl" placeholder="Feature Layer URL" />
        <input id="apiKey" placeholder="ArcGIS API Key (optional for private layers)" />
        <div class="row">
          <input id="accountField" placeholder="Account # field" value="Customer_Account_Number" style="flex:1" />
          <button id="connect" class="primary" title="Load layer">Connect</button>
        </div>
        <div class="muted" style="font-size:12px">Tip: Restrict your API key to this site in your ArcGIS developer settings.</div>
      </div>

      <div class="section stack">
        <div class="row">
          <input id="q" placeholder="Search account # or address" style="flex:1"/>
          <button id="btnSearch" class="ghost">Search</button>
          <button id="btnClear" class="ghost">Clear</button>
        </div>
        <div id="list"></div>
      </div>

      <div class="section stack" id="detail" style="display:none">
        <div class="muted">Selected meter</div>
        <div>OID: <span id="oid" class="kbd">—</span></div>
        <div>Account #: <span id="acct" class="kbd">—</span></div>
        <div>Address: <span id="addr" class="kbd">—</span></div>
        <div class="row">
          <input id="newAcct" placeholder="New account number" style="flex:1" />
          <button id="btnUpdate" class="primary">Update</button>
        </div>
        <button id="btnZoom" class="ghost">Zoom to feature</button>
      </div>
    </div>
  </div>

  <!-- MAP PANEL -->
  <div id="viewDiv">
    <div class="toolbar">
      <button id="drawRect" class="fab ghost" title="Draw rectangle to select">Draw box</button>
      <button id="clearSel" class="fab ghost" title="Clear selection">Clear</button>
    </div>
    <div id="searchDiv"></div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script src="https://js.arcgis.com/4.30/"></script>
<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const els = {
    layerUrl: $('#layerUrl'), apiKey: $('#apiKey'), accountField: $('#accountField'), connect: $('#connect'),
    q: $('#q'), btnSearch: $('#btnSearch'), btnClear: $('#btnClear'), list: $('#list'), detail: $('#detail'),
    oid: $('#oid'), acct: $('#acct'), addr: $('#addr'), newAcct: $('#newAcct'), btnUpdate: $('#btnUpdate'),
    drawRect: $('#drawRect'), clearSel: $('#clearSel'), btnZoom: $('#btnZoom')
  };
  const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._t); t._t=setTimeout(()=>t.style.display='none', 2600); };

  // Remember last config
  els.layerUrl.value = localStorage.meter_layer || '';
  els.apiKey.value = localStorage.meter_key || '';
  els.accountField.value = localStorage.meter_acct || 'Customer_Account_Number';

  require([
    'esri/Map','esri/views/MapView','esri/layers/FeatureLayer','esri/widgets/Search',
    'esri/layers/GraphicsLayer','esri/widgets/Sketch','esri/core/reactiveUtils','esri/config','esri/request'
  ], function(Map,MapView,FeatureLayer,Search,GraphicsLayer,Sketch,reactiveUtils,esriConfig,esriRequest){

    const map = new Map({ basemap: 'arcgis-topographic' });
    const view = new MapView({ container: 'viewDiv', map, center: [-97.323, 27.877], zoom: 13 });

    const drawLayer = new GraphicsLayer();
    map.add(drawLayer);

    const sketch = new Sketch({ view, layer: drawLayer, creationMode: 'single', availableCreateTools: ['rectangle'] });
    sketch.visible = false; // open when user clicks Draw box
    view.ui.add(sketch, 'top-left');

    const search = new Search({ view });
    view.ui.add('searchDiv', 'top-right');
    search.container = 'searchDiv';

    let fl = null; let lv = null; let highlight = null; let selection = []; let objIdField = 'OBJECTID';

    function clearSelection(){ selection = []; if(highlight){ highlight.remove(); highlight=null; } drawLayer.removeAll(); els.list.innerHTML=''; els.detail.style.display='none'; }

    function acctField(){ return (els.accountField.value||'Customer_Account_Number').trim(); }

    function addrFromAttrs(a){ return a.Service_Address || a.Address || a.FullAddres || a.SiteAddress || a.SITEADD || ''; }

    function acctFromAttrs(a){ return a[acctField()] || a.Customer_Account_Number || a.Account || ''; }

    function renderList(features){
      if(!features.length){ els.list.innerHTML = '<div class="muted" style="padding:8px">No matches.</div>'; return; }
      const rows = features.map(f=>{
        const a=f.attributes; const oid=a[objIdField];
        const acct=acctFromAttrs(a) || '—';
        const addr=addrFromAttrs(a) || '—';
        return `<tr data-oid="${oid}"><td>${oid}</td><td>${acct}</td><td>${addr}</td></tr>`;
      }).join('');
      els.list.innerHTML = `<div style="max-height:35vh;overflow:auto;border-radius:12px"><table><thead><tr><th>OID</th><th>Account</th><th>Address</th></tr></thead><tbody>${rows}</tbody></table></div>`;
      els.list.querySelectorAll('tbody tr').forEach(tr=>{
        tr.addEventListener('click', async ()=>{
          const oid = +tr.getAttribute('data-oid');
          const q = fl.createQuery(); q.where = objIdField + ' = ' + oid; q.returnGeometry = true; q.outFields = ['*'];
          const { features } = await fl.queryFeatures(q);
          if(features.length){ selectFeature(features[0]); }
        });
      });
    }

    function showDetail(f){
      const a = f.attributes; els.oid.textContent = a[objIdField]; els.acct.textContent = acctFromAttrs(a) || '—'; els.addr.textContent = addrFromAttrs(a) || '—';
      els.newAcct.value = acctFromAttrs(a) || '';
      els.detail.style.display = 'block';
    }

    function selectFeature(f){
      selection = [f];
      if(highlight){ highlight.remove(); }
      if(lv){ highlight = lv.highlight([ f.attributes[objIdField] ]); }
      showDetail(f);
      if(f.geometry){ view.goTo({ target:f.geometry, scale: 1500 }).catch(()=>{}); }
    }

    async function selectByGeometry(geometry){
      const q = fl.createQuery(); q.geometry = geometry; q.spatialRelationship = 'intersects'; q.returnGeometry = false; q.outFields=['*'];
      const { features } = await fl.queryFeatures(q);
      selection = features;
      if(highlight){ highlight.remove(); }
      if(lv){ highlight = lv.highlight(features.map(ft=> ft.attributes[objIdField])); }
      renderList(features);
      toast(features.length + ' feature(s) selected.');
    }

    async function runTextSearch(){
      if(!fl){ toast('Connect a layer first.'); return; }
      const t = (els.q.value||'').trim(); if(!t){ toast('Type a search.'); return; }
      const fields = [acctField(),'Customer_Account_Number','Account','Service_Address','Address','FullAddres'];
      const esc = t.replace(/'/g, "''");
      const where = fields.map(f=> `(${f} LIKE '%${esc}%')`).join(' OR ');
      const q = fl.createQuery(); q.where = where; q.outFields=['*']; q.returnGeometry=false;
      const { features } = await fl.queryFeatures(q);
      selection = features;
      if(highlight){ highlight.remove(); }
      if(lv){ highlight = lv.highlight(features.map(ft=> ft.attributes[objIdField])); }
      renderList(features);
      if(features[0]){ showDetail(features[0]); }
    }

    async function connect(){
      const url = els.layerUrl.value.trim(); if(!url){ toast('Enter a Feature Layer URL.'); return; }
      localStorage.meter_layer = url; localStorage.meter_key = els.apiKey.value.trim(); localStorage.meter_acct = acctField();
      if(els.apiKey.value.trim()){ esriConfig.apiKey = els.apiKey.value.trim(); }
      if(fl){ map.remove(fl); fl.destroy(); fl=null; }
      fl = new FeatureLayer({ url, outFields:['*'], popupEnabled: true });
      map.add(fl);
      await fl.when(); objIdField = fl.objectIdField || 'OBJECTID';
      lv = await view.whenLayerView(fl);
      // Configure Search to use this layer
      search.sources = [{
        layer: fl,
        name: 'Meters',
        searchFields: [acctField(),'Customer_Account_Number','Account','Service_Address','Address','FullAddres'],
        displayField: acctField(),
        outFields:['*'],
        suggestionTemplate: '{' + acctField() + '} — {' + (fl.displayField || 'Service_Address') + '}',
        minSuggestCharacters: 2,
        placeholder: 'Search meters'
      }];
      toast('Layer connected. You can search or draw a box.');
    }

    async function updateAccount(){
      if(!fl || !selection.length){ toast('Select a feature first.'); return; }
      const val = (els.newAcct.value||'').trim(); if(!val){ toast('Enter a new account number.'); return; }
      const oid = selection[0].attributes[objIdField];
      const edits = { updateFeatures: [{ attributes: Object.assign({}, { [objIdField]: oid, [acctField()]: val }) }] };
      try{
        const res = await fl.applyEdits(edits);
        const ok = res && res.updateFeatureResults && res.updateFeatureResults[0] && !res.updateFeatureResults[0].error;
        if(ok){
          selection[0].attributes[acctField()] = val; els.acct.textContent = val; toast('Account updated.');
        } else { toast('Update failed. Check permissions/field.'); }
      }catch(e){ console.error(e); toast('Update failed (network/permission).'); }
    }

    // UI wiring
    els.connect.addEventListener('click', connect);
    els.btnSearch.addEventListener('click', runTextSearch);
    els.btnClear.addEventListener('click', clearSelection);
    els.btnUpdate.addEventListener('click', updateAccount);
    els.btnZoom.addEventListener('click', ()=>{ if(selection[0]?.geometry){ view.goTo({ target: selection[0].geometry, scale: 1500 }); }});

    // Draw box flow
    els.drawRect.addEventListener('click', ()=>{ sketch.visible = true; sketch.create('rectangle'); });
    sketch.on('create', (e)=>{
      if(e.state === 'complete'){ selectByGeometry(e.graphic.geometry); sketch.visible=false; drawLayer.removeAll(); }
    });

    // Click map to select one
    view.on('click', async (evt)=>{
      if(!fl) return;
      const hit = await view.hitTest(evt, { include: [fl] });
      const g = hit?.results?.find(r=> r.graphic && r.graphic.layer === fl)?.graphic;
      if(g){
        const q = fl.createQuery(); q.where = objIdField + ' = ' + g.attributes[objIdField]; q.outFields=['*']; q.returnGeometry=true;
        const { features } = await fl.queryFeatures(q);
        if(features[0]){ selectFeature(features[0]); renderList(features); }
      }
    });
  });
})();
</script>
</body>
</html>
